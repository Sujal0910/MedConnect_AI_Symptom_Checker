{% extends "base.html" %}

{% block title %}Chat - MedConnect AI{% endblock %}

{% block content %}
<div class="flex-1 flex flex-col h-full p-4 md:p-8 lg:p-12" style="height: calc(100vh - 64px);">
    
    <!-- Chat Window -->
    <div id="chat-window" class="flex-1 bg-gray-800 rounded-lg shadow-inner overflow-y-auto p-6 space-y-4 mb-4">
        <!-- Messages will be dynamically added here -->
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden flex items-center justify-center mb-2">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        <span class="text-gray-400">MedConnect AI is thinking...</span>
    </div>

    <!-- 
      Input Form 
      We pass the Flask URLs to the script via data- attributes
      This is the most robust way to do it.
    -->
    <form id="chat-form" 
          class="flex items-center space-x-3"
          data-ask-url="{{ url_for('ask') }}"
          data-history-url="{{ url_for('get_history') }}"
          data-clear-url="{{ url_for('clear_chat') }}"
          data-user-name="{{ current_user.name }}">
        <input type="text" id="message-input" placeholder="Type your symptoms here..." autocomplete="off" class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" autofocus>
        <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
            Send
        </button>
    </form>
</div>

<!-- Custom Modal for Errors -->
<div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-lg shadow-2xl max-w-sm w-full p-6 border border-red-500">
        <h3 class="text-xl font-semibold text-red-400 mb-4">An Error Occurred</h3>
        <p id="error-message" class="text-gray-300 mb-6">Something went wrong. Please try again.</p>
        <button id="close-modal-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out">
            Close
        </button>
    </div>
</div>

<script>
    // --- Get DOM Elements ---
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorModal = document.getElementById('error-modal');
    const errorMessage = document.getElementById('error-message');
    const closeModalBtn = document.getElementById('close-modal-btn');

    // --- State & URLs ---
    // Read URLs safely from the data attributes
    const ASK_URL = chatForm.dataset.askUrl;
    const HISTORY_URL = chatForm.dataset.historyUrl;
    const CLEAR_URL = chatForm.dataset.clearUrl;
    const currentUserName = chatForm.dataset.userName;


    // --- Helper Functions ---

    /**
     * Adds a message to the chat window.
     * @param {string} sender - 'user' or 'assistant'
     * @param {string} text - The message text
     */
    function addMessageToChat(sender, text) {
        // Create the outer div that aligns the message
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('flex', 'w-full');

        // Create the message bubble
        const bubble = document.createElement('div');
        bubble.classList.add('rounded-lg', 'px-4', 'py-3', 'shadow-md', 'max-w-xl');

        if (sender === 'user') {
            // User: align right
            messageDiv.classList.add('justify-end');
            bubble.classList.add('bg-blue-600', 'text-white');
            bubble.textContent = text;
        } else {
            // Assistant: align left
            messageDiv.classList.add('justify-start');
            bubble.classList.add('bg-gray-700', 'text-white', 'prose', 'prose-invert', 'max-w-2xl', 'overflow-x-auto');
            // This is the fix: use Marked.js to parse Markdown to HTML
            // and apply prose for styling and overflow-x-auto for tables.
            bubble.innerHTML = marked.parse(text);
        }

        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        scrollToBottom();
    }

    /**
     * Scrolls the chat window to the bottom.
     */
    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /**
     * Toggles the UI state between loading and idle.
     * @param {boolean} isLoading - True if loading, false if idle
     */
    function setLoading(isLoading) {
        if (isLoading) {
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            messageInput.disabled = true;
        } else {
            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        }
    }

    /**
     * Shows a custom, non-blocking error modal.
     * @param {string} message - The error message to display
     */
    function showCustomError(message) {
        errorMessage.textContent = message;
        errorModal.classList.remove('hidden');
    }

    // --- Event Handlers ---

    /**
     * Handles the chat form submission.
     */
    async function handleChatSubmit(e) {
        e.preventDefault(); // Stop the form from reloading the page
        const message = messageInput.value.trim();
        if (!message) return;

        addMessageToChat('user', message);
        messageInput.value = '';
        setLoading(true);

        try {
            const response = await fetch(ASK_URL, {
                method: 'POST',
                // This 'credentials' line is CRITICAL for Flask-Login
                credentials: 'same-origin', 
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }

            // Check if the server sent JSON or (incorrectly) HTML
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                // This means the session is invalid, and we got the login page.
                throw new Error("Your session has expired. Please log out and log back in.");
            }

            const data = await response.json();
            addMessageToChat('assistant', data.answer);

        } catch (error) {
            console.error('Error during fetch:', error);
            showCustomError(error.message);
        } finally {
            setLoading(false);
        }
    }

    /**
     * Fetches and loads the chat history.
     */
    async function loadHistory() {
        setLoading(true);
        try {
            const response = await fetch(HISTORY_URL, {
                method: 'GET',
                credentials: 'same-origin' 
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }
            
            // Check if the server sent JSON or (incorrectly) HTML
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Your session has expired. Please log out and log back in.");
            }

            const history = await response.json();
            
            if (history.length > 0) {
                history.forEach(msg => addMessageToChat(msg.role, msg.content));
            } else {
                // Show welcome message if history is empty
                addMessageToChat('assistant', `Welcome, ${currentUserName}! I'm MedConnect AI. How can I help you today? \n\nI am an AI, not a doctor. Please consult a medical professional for any serious health concerns.`);
            }

        } catch (error) {
            console.error('Error loading history:', error);
            showCustomError(error.message || 'Could not load chat history. Please refresh the page.');
        } finally {
            setLoading(false);
            scrollToBottom();
        }
    }

    /**
     * Handles the "Clear Chat" button click.
     */
    async function handleClearChat(e) {
        e.preventDefault();
        
        // This is a stub for a custom, non-blocking confirm modal
        // In a real app, you'd build a beautiful modal here.
        if (!window.confirm("Are you sure you want to clear your chat history? This cannot be undone.")) {
            return;
        }
        
        console.log("Attempting to clear chat...");
        
        try {
            const response = await fetch(CLEAR_URL, {
                method: 'POST',
                credentials: 'same-origin' 
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }
            
            // Check if the server sent JSON or (incorrectly) HTML
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Your session has expired. Please log out and log back in.");
            }

            // Clear chat window
            chatWindow.innerHTML = '';
            // Show welcome message again
            addMessageToChat('assistant', `Welcome, ${currentUserName}! I'm MedConnect AI. How can I help you today? \n\nI am an AI, not a doctor. Please consult a medical professional for any serious health concerns.`);

        } catch (error) {
            console.error('Error clearing chat:', error);
            showCustomError(error.message);
        }
    }

    // --- Attach Event Listeners ---
    chatForm.addEventListener('submit', handleChatSubmit);
    
    // Attach listener to the "Clear Chat" button in the navbar
    const clearChatBtn = document.getElementById('clear-chat-btn');
    if (clearChatBtn) {
        clearChatBtn.addEventListener('click', handleClearChat);
    }

    closeModalBtn.addEventListener('click', () => {
        errorModal.classList.add('hidden');
    });

    // --- Initial Load ---
    loadHistory();

</script>
{% endblock %}

