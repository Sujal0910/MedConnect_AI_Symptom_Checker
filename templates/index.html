{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- NEW: Light-mode container -->
<div class="flex-1 flex flex-col h-full p-4 md:p-8 lg:p-12" style="height: calc(100vh - 64px);">
    
    <!-- Chat Window -->
    <!-- NEW: Re-skinned for light-mode. bg-white, shadow-lg, border-brand-stone -->
    <div id="chat-window" class="flex-1 bg-white rounded-lg shadow-lg overflow-y-auto p-6 space-y-4 mb-4 border border-brand-stone border-opacity-20">
        <!-- 
          Chat messages will be dynamically injected here.
          The 'Welcome' message will be added by the loadHistory() script.
        -->
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden flex items-center justify-center mb-2 space-x-2">
        <!-- NEW: Re-skinned for light-mode -->
        <span class="text-sm text-brand-olive">Medullose is thinking...</span>
        <div class="h-2 w-2 bg-brand-olive rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
        <div class="h-2 w-2 bg-brand-olive rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
        <div class="h-2 w-2 bg-brand-olive rounded-full animate-bounce"></div>
    </div>

    <!-- 
      Input Form 
      NEW: Re-skinned for light-mode.
    -->
    <form id="chat-form" 
          class="flex items-center space-x-3"
          data-ask-url="{{ url_for('ask') }}"
          data-history-url="{{ url_for('get_history') }}"
          data-clear-url="{{ url_for('clear_chat') }}"
          data-user-name="{{ current_user.name }}">
        
        <!-- NEW: bg-white, border-brand-stone, text-brand-forest -->
        <input type="text" id="message-input" placeholder="Type your symptoms here..." autocomplete="off" class="flex-1 p-3 bg-white border border-brand-stone rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-brand-forest" autofocus>
        
        <!-- NEW: Blue button (as requested) -->
        <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out">
            Send
        </button>
    </form>
</div>

<!-- Custom Modal for Errors -->
<!-- NEW: Re-skinned for light-mode -->
<div id="error-modal" class="hidden fixed inset-0 bg-brand-forest bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
        <h3 class="text-xl font-bold text-red-600 mb-4">An Error Occurred</h3>
        <p id="error-message-text" class="text-brand-olive mb-6">Something went wrong.</p>
        <button id="close-modal-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">
            Close
        </button>
    </div>
</div>

<script>
    // --- Get DOM Elements ---
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');
    const clearChatBtn = document.getElementById('clear-chat-btn');

    // Modal elements
    const errorModal = document.getElementById('error-modal');
    const errorMessageText = document.getElementById('error-message-text');
    const closeModalBtn = document.getElementById('close-modal-btn');

    // --- State & URLs ---
    const ASK_URL = chatForm.dataset.askUrl;
    const HISTORY_URL = chatForm.dataset.historyUrl;
    const CLEAR_URL = chatForm.dataset.clearUrl;
    const currentUserName = chatForm.dataset.userName;


    // --- Helper Functions ---

    /**
     * Adds a message to the chat window.
     * @param {string} sender - 'user' or 'assistant'
     * @param {string} text - The message text
     */
    function addMessageToChat(sender, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex w-full';

        const bubble = document.createElement('div');
        // NEW: Added overflow-x-auto to fix table/code block overflow
        bubble.className = 'max-w-xl p-3 rounded-lg shadow-md overflow-x-auto';

        if (sender === 'user') {
            // --- NEW: User bubble styling (Blue) ---
            messageDiv.classList.add('justify-end');
            bubble.classList.add('bg-blue-600', 'text-white');
            bubble.textContent = text;
        } else {
            // --- NEW: Assistant bubble styling (Light Gray) ---
            messageDiv.classList.add('justify-start');
            bubble.classList.add('bg-gray-100', 'text-brand-forest');
            
            // Use Marked.js to render Markdown, and add prose styles
            bubble.innerHTML = marked.parse(text);
            bubble.classList.add('prose', 'prose-custom'); 
        }

        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        scrollToBottom();
    }

    /**
     * Scrolls the chat window to the bottom.
     */
    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /**
     * Toggles the UI state between loading and idle.
     * @param {boolean} isLoading - True if loading, false if idle
     */
    function setLoading(isLoading) {
        if (isLoading) {
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    /**
     * Shows a custom, non-blocking error modal.
     * @param {string} message - The error message to display
     */
    function showCustomError(message) {
        errorMessageText.textContent = message;
        errorModal.classList.remove('hidden');
    }

    // --- Event Handlers ---

    /**
     * Handles the chat form submission.
     */
    async function handleChatSubmit(e) {
        e.preventDefault(); // Stop page reload
        const message = messageInput.value.trim();
        if (!message) return;

        addMessageToChat('user', message);
        messageInput.value = '';
        setLoading(true);

        try {
            const response = await fetch(ASK_URL, {
                method: 'POST',
                credentials: 'same-origin', // Send cookies
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message }),
            });

            // Check for non-JSON responses (like a login redirect)
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                if(response.status === 500) {
                     throw new Error("The server encountered an internal error. Please try again.");
                } else {
                     throw new Error("Your session has expired. Please log out and log back in.");
                }
            }
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'An unknown error occurred.');
            }

            const data = await response.json();
            addMessageToChat('assistant', data.answer);

        } catch (error) {
            console.error('Error during fetch:', error);
            showCustomError(error.message);
        } finally {
            setLoading(false);
        }
    }

    /**
     * Fetches and loads the chat history.
     */
    async function loadHistory() {
        setLoading(true);
        try {
            const response = await fetch(HISTORY_URL, {
                method: 'GET',
                credentials: 'same-origin' // Send cookies
            });
            
            // Check for non-JSON responses
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Your session has expired. Please log out and log back in.");
            }
            
            if (!response.ok) {
                 const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load history.');
            }

            const history = await response.json();
            
            if (history.length > 0) {
                history.forEach(msg => {
                    addMessageToChat(msg.role, msg.content);
                });
            } else {
                // Show welcome message if history is empty
                addMessageToChat('assistant', `Welcome, ${currentUserName}! I'm Medullose. How can I help you today? \n\nI am an AI, not a doctor. Please consult a medical professional for any serious health concerns.`);
            }

        } catch (error) {
            console.error('Error loading history:', error);
            showCustomError(error.message);
        } finally {
            setLoading(false);
            scrollToBottom();
        }
    }

    /**
     * Handles the "Clear Chat" button click.
     */
    async function handleClearChat(e) {
        e.preventDefault();
        
        // Use a simple, non-blocking confirm
        if (!window.confirm("Are you sure you want to clear your entire chat history?")) {
            return;
        }
        
        try {
            const response = await fetch(CLEAR_URL, {
                method: 'POST',
                credentials: 'same-origin' // Send cookies
            });

            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Your session has expired. Please log out and log back in.");
            }
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to clear chat.');
            }

            // Clear chat window
            chatWindow.innerHTML = '';
            // Show new welcome message
            addMessageToChat('assistant', `Welcome, ${currentUserName}! I'm Medullose. How can I help you today? \n\nI am an AI, not a doctor. Please consult a medical professional for any serious health concerns.`);

        } catch (error) {
            console.error('Error clearing chat:', error);
            showCustomError(error.message);
        }
    }

    // --- Attach Event Listeners ---
    chatForm.addEventListener('submit', handleChatSubmit);
    
    // Check if clearChatBtn exists (it's in base.html)
    if(clearChatBtn) {
        clearChatBtn.addEventListener('click', handleClearChat);
    }
    
    closeModalBtn.addEventListener('click', () => {
        errorModal.classList.add('hidden');
    });

    // --- Initial Load ---
    loadHistory();

</script>
{% endblock %}